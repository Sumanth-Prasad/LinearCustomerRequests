{% extends "layout.html" %}

{% block title %} - Issue Details{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Teams</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('projects', team_id=issue.team.id) }}">Projects</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('roadmap', team_id=issue.team.id) }}">Roadmap</a></li>
                <li class="breadcrumb-item active">{{ issue.identifier }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0">{{ issue.identifier }} <span id="issue-title-display">{{ issue.title }}</span></h3>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" id="edit-issue-btn">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" id="delete-issue-btn">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="issue-view-mode">
                    <p class="mb-3"><strong>Description:</strong></p>
                    <div class="p-3 rounded markdown-content" id="issue-description-display">{{ issue.description or 'No description provided.' }}</div>
                </div>
                
                <div id="issue-edit-mode" style="display: none;">
                    <form id="issue-edit-form">
                        <div class="mb-3">
                            <label for="issue-title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="issue-title" value="{{ issue.title }}">
                        </div>
                        <div class="mb-3">
                            <label for="issue-description" class="form-label">Description</label>
                            <textarea class="form-control" id="issue-description" rows="6">{{ issue.description }}</textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="issue-state" class="form-label">State</label>
                                <select class="form-select" id="issue-state">
                                    {% for state in workflow_states %}
                                    <option value="{{ state.id }}" {% if state.id == issue.state.id %}selected{% endif %}>{{ state.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="issue-assignee" class="form-label">Assignee</label>
                                <select class="form-select" id="issue-assignee">
                                    <option value="">Unassigned</option>
                                    {% for member in team_members %}
                                    <option value="{{ member.id }}" {% if issue.assignee and member.id == issue.assignee.id %}selected{% endif %}>{{ member.displayName or member.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" id="cancel-edit-btn">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Comments</h4>
            </div>
            <div class="card-body">
                <div id="comments-container">
                    {% if issue.comments and issue.comments.nodes %}
                        {% for comment in issue.comments.nodes %}
                        <div class="comment mb-3" data-comment-id="{{ comment.id }}">
                            <div class="comment-author d-flex justify-content-between">
                                <div>
                                    {% if comment.user %}
                                    {{ comment.user.displayName or comment.user.name }}
                                    {% else %}
                                    <span class="user-label badge bg-secondary">Added via API</span>
                                    {% endif %}
                                    <span class="comment-date">{{ comment.createdAt|format_date }}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="{{ comment.id }}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div class="comment-body markdown-content p-3 rounded">{{ comment.body }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No comments yet.</p>
                    {% endif %}
                </div>
                
                <div class="comment-form mt-4">
                    <h5>Add a Comment</h5>
                    <form id="commentForm">
                        <div class="mb-3">
                            <textarea class="form-control" id="comment" rows="3" placeholder="Type your comment here..." required></textarea>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-primary">Add Comment</button>
                            <div id="commentStatus" class="mt-2"></div>
                        </div>
                    </form>
                    
                    <div class="mt-4 fallback-comment-section" style="display:none;" id="fallbackCommentSection">
                        <div class="alert alert-warning">
                            <p><strong>Couldn't create comment via API.</strong> This might be due to API permission limitations.</p>
                            <p>As an alternative, you can add your comment directly in Linear:</p>
                            <a href="https://linear.app/{{ issue.team.name|lower }}/issue/{{ issue.identifier }}" target="_blank" class="btn btn-outline-primary">
                                Open in Linear <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h4 class="card-title">Issue Details</h4>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Identifier</span>
                        <span class="badge bg-primary">{{ issue.identifier }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Status</span>
                        <span class="badge" style="background-color: {{ issue.state.color }};">{{ issue.state.name }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Assignee</span>
                        <span>{{ issue.assignee.displayName or issue.assignee.name if issue.assignee else 'Unassigned' }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Team</span>
                        <span>{{ issue.team.name }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Create context menus
        const issueContextMenu = $('<div>')
            .addClass('dropdown-menu context-menu')
            .css({
                position: 'absolute',
                zIndex: 1000,
                display: 'none'
            })
            .append(
                $('<a>')
                    .addClass('dropdown-item text-danger')
                    .attr('href', '#')
                    .attr('id', 'delete-issue')
                    .html('<i class="fas fa-trash-alt me-2"></i>Delete Issue')
            )
            .appendTo('body');
            
        const commentContextMenu = $('<div>')
            .addClass('dropdown-menu context-menu')
            .css({
                position: 'absolute',
                zIndex: 1000,
                display: 'none'
            })
            .append(
                $('<a>')
                    .addClass('dropdown-item text-danger')
                    .attr('href', '#')
                    .attr('id', 'delete-comment')
                    .html('<i class="fas fa-trash-alt me-2"></i>Delete Comment')
            )
            .appendTo('body');
        
        let currentCommentElement = null;
        let currentCommentId = null;
        
        // Add style for context menu if not already defined
        if (!document.getElementById('context-menu-styles')) {
            $('<style id="context-menu-styles">')
                .text(`
                    .context-menu {
                        min-width: 180px;
                        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
                        border: 1px solid rgba(0, 0, 0, 0.1);
                        background-color: #fff;
                        padding: 0.5rem 0;
                    }
                    
                    .context-menu .dropdown-item {
                        padding: 0.5rem 1rem;
                        cursor: pointer;
                    }
                    
                    .context-menu .dropdown-item:hover {
                        background-color: #f8f9fa;
                    }
                    
                    [data-bs-theme="dark"] .context-menu {
                        background-color: #343a40;
                        border-color: rgba(255, 255, 255, 0.1);
                    }
                    
                    [data-bs-theme="dark"] .context-menu .dropdown-item {
                        color: #fff;
                    }
                    
                    [data-bs-theme="dark"] .context-menu .dropdown-item:hover {
                        background-color: #495057;
                    }
                    
                    .comment {
                        position: relative;
                    }
                    
                    .card-header {
                        position: relative;
                    }
                `)
                .appendTo('head');
        }
        
        // Right-click on issue header
        $('.card-header').on('contextmenu', function(e) {
            // Only show menu on the main issue header
            if ($(this).find('#issue-title-display').length === 0) {
                return;
            }
            
            e.preventDefault();
            
            // Hide other context menus
            commentContextMenu.hide();
            
            // Position and show issue context menu
            issueContextMenu.css({
                top: e.pageY + 'px',
                left: e.pageX + 'px'
            }).show();
            
            // Hide menu when clicking elsewhere
            $(document).one('click', function() {
                issueContextMenu.hide();
            });
        });
        
        // Right-click on comment
        $('.comment').on('contextmenu', function(e) {
            e.preventDefault();
            
            // Hide other context menus
            issueContextMenu.hide();
            
            // Store the current comment
            currentCommentElement = $(this);
            currentCommentId = $(this).data('comment-id');
            
            // Only show delete option if there's a comment ID
            if (!currentCommentId) {
                return;
            }
            
            // Position and show comment context menu
            commentContextMenu.css({
                top: e.pageY + 'px',
                left: e.pageX + 'px'
            }).show();
            
            // Hide menu when clicking elsewhere
            $(document).one('click', function() {
                commentContextMenu.hide();
            });
        });
        
        // Handle delete issue action
        $('#delete-issue').on('click', function(e) {
            e.preventDefault();
            
            const issueId = '{{ issue.id }}';
            const issueIdentifier = '{{ issue.identifier }}';
            
            // Show confirmation dialog
            if (confirm(`Are you sure you want to delete issue ${issueIdentifier}? This action cannot be undone.`)) {
                // Show loading overlay
                const overlay = $('<div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index: 9999;">')
                    .append('<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>')
                    .appendTo('body');
                
                // Send delete request
                fetch(`/api/delete_issue/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    overlay.remove();
                    
                    if (data.success) {
                        // Show success message
                        const message = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                            .text(`Issue ${issueIdentifier} has been deleted`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            message.fadeOut(() => message.remove());
                            // Redirect to roadmap
                            window.location.href = "{{ url_for('roadmap', team_id=issue.team.id) }}";
                        }, 1500);
                    } else {
                        // Show error message
                        const message = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                            .text(`Error: ${data.error || 'Failed to delete issue'}`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            message.fadeOut(() => message.remove());
                        }, 3000);
                    }
                })
                .catch(error => {
                    overlay.remove();
                    
                    // Show error message
                    const message = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                        .text(`Error: ${error.message || 'Network error'}`)
                        .appendTo('body');
                    
                    setTimeout(() => {
                        message.fadeOut(() => message.remove());
                    }, 3000);
                });
            }
        });
        
        // Add handler for delete issue button
        $('#delete-issue-btn').on('click', function() {
            const issueId = '{{ issue.id }}';
            const issueIdentifier = '{{ issue.identifier }}';
            
            // Show confirmation dialog
            if (confirm(`Are you sure you want to delete issue ${issueIdentifier}? This action cannot be undone.`)) {
                // Show loading overlay
                const overlay = $('<div class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-flex align-items-center justify-content-center" style="z-index: 9999;">')
                    .append('<div class="spinner-border text-light" role="status"><span class="visually-hidden">Loading...</span></div>')
                    .appendTo('body');
                
                // Send delete request
                fetch(`/api/delete_issue/${issueId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    overlay.remove();
                    
                    if (data.success) {
                        // Show success message
                        const message = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                            .text(`Issue ${issueIdentifier} has been deleted`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            message.fadeOut(() => message.remove());
                            // Redirect to roadmap
                            window.location.href = "{{ url_for('roadmap', team_id=issue.team.id) }}";
                        }, 1500);
                    } else {
                        // Show error message
                        const message = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                            .text(`Error: ${data.error || 'Failed to delete issue'}`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            message.fadeOut(() => message.remove());
                        }, 3000);
                    }
                })
                .catch(error => {
                    overlay.remove();
                    
                    // Show error message
                    const message = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">')
                        .text(`Error: ${error.message || 'Network error'}`)
                        .appendTo('body');
                    
                    setTimeout(() => {
                        message.fadeOut(() => message.remove());
                    }, 3000);
                });
            }
        });
        
        // Handle delete comment action
        $('#delete-comment').on('click', function(e) {
            e.preventDefault();
            
            if (!currentCommentId || !currentCommentElement) {
                return;
            }
            
            // Show confirmation dialog
            if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                // Add loading indicator to the comment
                const loadingOverlay = $('<div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75">')
                    .append('<div class="spinner-border text-primary"></div>')
                    .css('zIndex', 1000);
                
                currentCommentElement.css('position', 'relative').append(loadingOverlay);
                
                // Send delete request
                fetch(`/api/delete_comment/${currentCommentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove comment with animation
                        currentCommentElement.fadeOut(300, function() {
                            $(this).remove();
                            
                            // Add a "no comments" message if all comments are gone
                            if ($('.comment').length === 0) {
                                $('#comments-container').html('<p class="text-muted">No comments yet.</p>');
                            }
                        });
                        
                        // Show success notification
                        const successMsg = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x p-3">')
                            .text('Comment has been deleted')
                            .appendTo('body');
                        
                        setTimeout(() => {
                            successMsg.fadeOut(() => successMsg.remove());
                        }, 3000);
                    } else {
                        // Remove loading indicator
                        loadingOverlay.remove();
                        
                        const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                            .text(`Error: ${data.error || 'Failed to delete comment'}`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            errorMsg.fadeOut(() => errorMsg.remove());
                        }, 3000);
                    }
                })
                .catch(error => {
                    // Remove loading indicator
                    loadingOverlay.remove();
                    
                    const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                        .text(`Error: ${error.message || 'Network error'}`)
                        .appendTo('body');
                    
                    setTimeout(() => {
                        errorMsg.fadeOut(() => errorMsg.remove());
                    }, 3000);
                });
            }
        });
        
        // Add handler for delete comment buttons
        $('.delete-comment-btn').on('click', function() {
            const commentId = $(this).data('comment-id');
            const commentElement = $(this).closest('.comment');
            
            if (!commentId || !commentElement) {
                return;
            }
            
            // Show confirmation dialog
            if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                // Add loading indicator to the comment
                const loadingOverlay = $('<div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75">')
                    .append('<div class="spinner-border text-primary"></div>')
                    .css('zIndex', 1000);
                
                commentElement.css('position', 'relative').append(loadingOverlay);
                
                // Send delete request
                fetch(`/api/delete_comment/${commentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove comment with animation
                        commentElement.fadeOut(300, function() {
                            $(this).remove();
                            
                            // Add a "no comments" message if all comments are gone
                            if ($('.comment').length === 0) {
                                $('#comments-container').html('<p class="text-muted">No comments yet.</p>');
                            }
                        });
                        
                        // Show success notification
                        const successMsg = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x p-3">')
                            .text('Comment has been deleted')
                            .appendTo('body');
                        
                        setTimeout(() => {
                            successMsg.fadeOut(() => successMsg.remove());
                        }, 3000);
                    } else {
                        // Remove loading indicator
                        loadingOverlay.remove();
                        
                        const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                            .text(`Error: ${data.error || 'Failed to delete comment'}`)
                            .appendTo('body');
                        
                        setTimeout(() => {
                            errorMsg.fadeOut(() => errorMsg.remove());
                        }, 3000);
                    }
                })
                .catch(error => {
                    // Remove loading indicator
                    loadingOverlay.remove();
                    
                    const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                        .text(`Error: ${error.message || 'Network error'}`)
                        .appendTo('body');
                    
                    setTimeout(() => {
                        errorMsg.fadeOut(() => errorMsg.remove());
                    }, 3000);
                });
            }
        });
        
        // Track user's comments
        const USER_COMMENTS_KEY = 'linear_user_comments';
        
        // Load user comments from localStorage
        function getUserComments() {
            const saved = localStorage.getItem(USER_COMMENTS_KEY);
            return saved ? JSON.parse(saved) : [];
        }
        
        // Save a comment ID to localStorage
        function saveUserComment(commentId) {
            const comments = getUserComments();
            if (!comments.includes(commentId)) {
                comments.push(commentId);
                localStorage.setItem(USER_COMMENTS_KEY, JSON.stringify(comments));
            }
        }
        
        // Check if a comment was created by the current user
        function isUserComment(commentId) {
            return getUserComments().includes(commentId);
        }
        
        // Update comment labels - change "Added via API" to "You" for user comments
        function updateCommentLabels() {
            $('.comment').each(function() {
                const commentId = $(this).data('comment-id');
                if (commentId && isUserComment(commentId)) {
                    $(this).find('.user-label')
                           .removeClass('bg-secondary')
                           .addClass('bg-primary')
                           .text('You');
                }
            });
        }
        
        // Run on page load
        updateCommentLabels();
        
        // Issue editing
        $('#edit-issue-btn').click(function() {
            $('#issue-view-mode').hide();
            $('#issue-edit-mode').show();
        });
        
        $('#cancel-edit-btn').click(function() {
            $('#issue-edit-mode').hide();
            $('#issue-view-mode').show();
        });
        
        $('#issue-edit-form').submit(function(e) {
            e.preventDefault();
            
            const issueId = '{{ issue.id }}';
            const title = $('#issue-title').val().trim();
            const description = $('#issue-description').val().trim();
            const stateId = $('#issue-state').val();
            const assigneeId = $('#issue-assignee').val() || null;
            
            // Validate required fields
            if (!title) {
                const errorDiv = $('<div>')
                    .addClass('alert alert-danger mt-3')
                    .text('Title is required')
                    .appendTo($('#issue-edit-mode'));
                
                setTimeout(() => {
                    errorDiv.fadeOut(function() {
                        $(this).remove();
                    });
                }, 3000);
                return;
            }
            
            // Show a loading indicator
            const saveButton = $(this).find('button[type="submit"]');
            const originalText = saveButton.text();
            saveButton.prop('disabled', true).text('Saving...');
            
            // Prepare data for API
            const updateData = {
                title: title,
                description: description,
                stateId: stateId,
                assigneeId: assigneeId
            };
            
            // Log the data being sent for debugging
            console.log('Updating issue with data:', updateData);
            
            fetch(`/api/update_issue/${issueId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(updateData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the UI
                    $('#issue-title-display').text(title);
                    
                    // Update description with rendered markdown
                    const $descriptionDisplay = $('#issue-description-display');
                    $descriptionDisplay.text(description);
                    $descriptionDisplay.html(renderMarkdown(description));
                    
                    // Show success message
                    const successDiv = $('<div>')
                        .addClass('alert alert-success mt-3')
                        .text('Issue updated successfully')
                        .appendTo($('#issue-edit-mode'));
                    
                    setTimeout(() => {
                        successDiv.fadeOut(function() {
                            $(this).remove();
                        });
                        
                        // Switch back to view mode
                        $('#issue-edit-mode').hide();
                        $('#issue-view-mode').show();
                    }, 1500);
                } else {
                    // Show error message
                    const errorDiv = $('<div>')
                        .addClass('alert alert-danger mt-3')
                        .text(`Error: ${data.error || 'Failed to update issue'}`)
                        .appendTo($('#issue-edit-mode'));
                    
                    setTimeout(() => {
                        errorDiv.fadeOut(function() {
                            $(this).remove();
                        });
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error updating issue:', error);
                
                // Show error message
                const errorDiv = $('<div>')
                    .addClass('alert alert-danger mt-3')
                    .text(`Error: ${error.message || 'Network error'}`)
                    .appendTo($('#issue-edit-mode'));
                
                setTimeout(() => {
                    errorDiv.fadeOut(function() {
                        $(this).remove();
                    });
                }, 3000);
            })
            .finally(() => {
                // Reset button
                saveButton.prop('disabled', false).text(originalText);
            });
        });
        
        // Comment handling
        $('#commentForm').submit(function(e) {
            e.preventDefault();
            
            const commentText = $('#comment').val().trim();
            if (!commentText) {
                return;
            }
            
            // Disable submit button
            const submitBtn = $(this).find('button[type="submit"]');
            submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
            
            // Show status
            $('#commentStatus').empty();
            
            // Send comment to API
            fetch(`/api/add_comment/{{ issue.id }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    comment: commentText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Create a new comment element
                    const timestamp = new Date().toISOString();
                    const formattedDate = new Date().toLocaleString();
                    
                    // Store the comment ID
                    if (data.commentId) {
                        saveUserComment(data.commentId);
                    }
                    
                    // Create the comment HTML with markdown rendering
                    const commentHtml = `
                        <div class="comment mb-3" data-comment-id="${data.commentId || ''}">
                            <div class="comment-author d-flex justify-content-between">
                                <div>
                                    <span class="user-label badge bg-primary">You</span>
                                    <span class="comment-date">${formattedDate}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="${data.commentId || ''}">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div class="comment-body markdown-content p-3 rounded">${commentText}</div>
                        </div>
                    `;
                    
                    // Add to UI
                    const $newComment = $(commentHtml);
                    $('#comments-container').append($newComment);
                    
                    // Apply markdown rendering
                    $newComment.find('.markdown-content').each(function() {
                        $(this).html(renderMarkdown($(this).text()));
                    });
                    
                    // Bind the delete event handler to the new comment's delete button
                    $newComment.find('.delete-comment-btn').on('click', function() {
                        const commentId = $(this).data('comment-id');
                        const commentElement = $(this).closest('.comment');
                        
                        if (!commentId || !commentElement) {
                            return;
                        }
                        
                        // Show confirmation dialog
                        if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
                            // Add loading indicator to the comment
                            const loadingOverlay = $('<div class="position-absolute top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75">')
                                .append('<div class="spinner-border text-primary"></div>')
                                .css('zIndex', 1000);
                            
                            commentElement.css('position', 'relative').append(loadingOverlay);
                            
                            // Send delete request
                            fetch(`/api/delete_comment/${commentId}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Remove comment with animation
                                    commentElement.fadeOut(300, function() {
                                        $(this).remove();
                                        
                                        // Add a "no comments" message if all comments are gone
                                        if ($('.comment').length === 0) {
                                            $('#comments-container').html('<p class="text-muted">No comments yet.</p>');
                                        }
                                    });
                                    
                                    // Show success notification
                                    const successMsg = $('<div class="alert alert-success position-fixed top-0 start-50 translate-middle-x p-3">')
                                        .text('Comment has been deleted')
                                        .appendTo('body');
                                    
                                    setTimeout(() => {
                                        successMsg.fadeOut(() => successMsg.remove());
                                    }, 3000);
                                } else {
                                    // Remove loading indicator
                                    loadingOverlay.remove();
                                    
                                    const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                                        .text(`Error: ${data.error || 'Failed to delete comment'}`)
                                        .appendTo('body');
                                    
                                    setTimeout(() => {
                                        errorMsg.fadeOut(() => errorMsg.remove());
                                    }, 3000);
                                }
                            })
                            .catch(error => {
                                // Remove loading indicator
                                loadingOverlay.remove();
                                
                                const errorMsg = $('<div class="alert alert-danger position-fixed top-0 start-50 translate-middle-x p-3">')
                                    .text(`Error: ${error.message || 'Network error'}`)
                                    .appendTo('body');
                                
                                setTimeout(() => {
                                    errorMsg.fadeOut(() => errorMsg.remove());
                                }, 3000);
                            });
                        }
                    });
                    
                    // Clear comment form
                    $('#comment').val('');
                    
                    // Show success message
                    $('#commentStatus').html('<div class="alert alert-success">Comment added successfully</div>');
                    
                    // Remove the "No comments yet" message if it exists
                    $('#comments-container .text-muted').remove();
                } else {
                    console.error('Error adding comment:', data.error);
                    $('#commentStatus').html(`<div class="alert alert-danger">Error: ${data.error || 'Failed to add comment'}</div>`);
                    
                    // Show the fallback section
                    $('#fallbackCommentSection').show();
                }
            })
            .catch(error => {
                console.error('Network error:', error);
                $('#commentStatus').html(`<div class="alert alert-danger">Error: ${error.message || 'Network error'}</div>`);
                
                // Show the fallback section
                $('#fallbackCommentSection').show();
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.prop('disabled', false).text('Add Comment');
            });
        });
    });
</script>
{% endblock %} 